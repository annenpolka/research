name: Checkout with GitHub App Token

# This workflow demonstrates using GitHub App authentication
# which is recommended for organization-wide access management

on:
  workflow_dispatch:
    inputs:
      target_repo:
        description: 'Repository to checkout (owner/repo)'
        required: false
        default: 'actions/toolkit'

jobs:
  checkout-with-app:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main repository
        uses: actions/checkout@v4
        with:
          path: main

      # Generate token from GitHub App
      # Requires APP_ID and APP_PRIVATE_KEY secrets
      - name: Generate GitHub App Token
        id: app_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          # Optional: specify which repositories to access
          # repositories: |
          #   repo-a
          #   repo-b
        continue-on-error: true

      - name: Checkout with App Token
        if: steps.app_token.outcome == 'success'
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.inputs.target_repo || 'actions/toolkit' }}
          token: ${{ steps.app_token.outputs.token }}
          path: external-repo

      - name: Verify checkout
        if: steps.app_token.outcome == 'success'
        run: |
          echo "✓ Successfully checked out repository with GitHub App token"
          ls -la external-repo/

      - name: Use GitHub CLI with App Token
        if: steps.app_token.outcome == 'success'
        env:
          GH_TOKEN: ${{ steps.app_token.outputs.token }}
        run: |
          echo "Using GitHub App token with gh CLI:"
          gh repo view ${{ github.event.inputs.target_repo || 'actions/toolkit' }}

      - name: Show setup instructions
        if: steps.app_token.outcome != 'success'
        run: |
          cat << 'EOF'
          ╔════════════════════════════════════════════════════════════╗
          ║           GitHub App Setup Instructions                    ║
          ╠════════════════════════════════════════════════════════════╣

          Step 1: Create a GitHub App
          ────────────────────────────────────────────────────────────

          1. Go to GitHub Settings:
             - User: https://github.com/settings/apps
             - Org:  https://github.com/organizations/YOUR-ORG/settings/apps

          2. Click "New GitHub App"

          3. Fill in basic information:
             - GitHub App name: "Cross-Repository Actions"
             - Homepage URL: Your repository URL
             - Webhook: Uncheck "Active"

          4. Set Repository permissions:
             - Contents: Read-only (or Read and write if needed)
             - Metadata: Read-only (automatically selected)

          5. Where can this app be installed?
             - Select "Only on this account"

          6. Click "Create GitHub App"


          Step 2: Generate Private Key
          ────────────────────────────────────────────────────────────

          1. On the app's settings page, scroll to "Private keys"
          2. Click "Generate a private key"
          3. A .pem file will be downloaded - save it securely
          4. Note the App ID at the top of the page


          Step 3: Install the GitHub App
          ────────────────────────────────────────────────────────────

          1. In the app settings, click "Install App" tab
          2. Select your account or organization
          3. Choose repository access:
             - All repositories, or
             - Only select repositories (recommended)
          4. Click "Install"


          Step 4: Add Secrets to Repository
          ────────────────────────────────────────────────────────────

          Go to: Repository → Settings → Secrets → Actions

          Add two secrets:

          1. APP_ID
             Value: The App ID from step 2

          2. APP_PRIVATE_KEY
             Value: The entire content of the .pem file, including:
             -----BEGIN RSA PRIVATE KEY-----
             ...
             -----END RSA PRIVATE KEY-----


          Step 5: Use in Workflow
          ────────────────────────────────────────────────────────────

          - name: Generate token
            id: app_token
            uses: actions/create-github-app-token@v1
            with:
              app-id: ${{ secrets.APP_ID }}
              private-key: ${{ secrets.APP_PRIVATE_KEY }}

          - name: Checkout private repo
            uses: actions/checkout@v4
            with:
              repository: owner/private-repo
              token: ${{ steps.app_token.outputs.token }}
              path: repo

          ╚════════════════════════════════════════════════════════════╝
          EOF

  # Advanced: GitHub App with specific repository access
  checkout-with-scoped-app:
    runs-on: ubuntu-latest

    steps:
      - name: Generate token for specific repositories
        id: scoped_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          # Limit access to specific repositories
          repositories: |
            repo-a
            repo-b
            shared-config
        continue-on-error: true

      - name: Show scoped access benefits
        run: |
          echo "=== Benefits of Scoped GitHub App Tokens ==="
          echo ""
          echo "✓ Principle of least privilege"
          echo "✓ Token only works for specified repositories"
          echo "✓ Better audit trail"
          echo "✓ Automatic token expiration (1 hour)"
          echo "✓ Not tied to individual user accounts"
          echo ""
          echo "Example: Token generated above can only access:"
          echo "  - repo-a"
          echo "  - repo-b"
          echo "  - shared-config"

  # Comparison: GitHub App vs other methods
  comparison:
    runs-on: ubuntu-latest

    steps:
      - name: Authentication Methods Comparison
        run: |
          cat << 'EOF'
          ╔═══════════════════════════════════════════════════════════════════════╗
          ║              Authentication Methods Comparison                        ║
          ╠═══════════════════════════════════════════════════════════════════════╣
          ║                                                                       ║
          ║ Method           │ Scope        │ Expiry  │ User-tied │ Best For     ║
          ║──────────────────┼──────────────┼─────────┼───────────┼──────────────║
          ║ GitHub App       │ Configurable │ 1 hour  │ No        │ Orgs/Teams   ║
          ║ Deploy Key (SSH) │ 1 repo       │ None    │ No        │ Single repo  ║
          ║ Fine-grained PAT │ Configurable │ Custom  │ Yes       │ Personal     ║
          ║ Classic PAT      │ All repos    │ Custom  │ Yes       │ Testing only ║
          ║ GITHUB_TOKEN     │ Current repo │ Job     │ No        │ Same repo    ║
          ║                                                                       ║
          ╠═══════════════════════════════════════════════════════════════════════╣
          ║                      GitHub App Advantages                            ║
          ╠═══════════════════════════════════════════════════════════════════════╣
          ║                                                                       ║
          ║ ✓ Fine-grained permissions (per repository, per permission type)     ║
          ║ ✓ Not tied to individual users (survives user departure)             ║
          ║ ✓ Automatic token rotation (generates new token each workflow)       ║
          ║ ✓ Higher rate limits than personal tokens                            ║
          ║ ✓ Detailed audit logs                                                ║
          ║ ✓ Can be managed by organization admins                              ║
          ║ ✓ Tokens automatically expire after 1 hour                           ║
          ║                                                                       ║
          ╠═══════════════════════════════════════════════════════════════════════╣
          ║                      When to Use GitHub App                           ║
          ╠═══════════════════════════════════════════════════════════════════════╣
          ║                                                                       ║
          ║ • Organization with multiple repositories                             ║
          ║ • Team environments where access shouldn't depend on individuals      ║
          ║ • Production systems requiring audit trails                           ║
          ║ • When you need more than basic read access                           ║
          ║ • Compliance requirements for access management                       ║
          ║                                                                       ║
          ╚═══════════════════════════════════════════════════════════════════════╝
          EOF

      - name: Decision Tree
        run: |
          echo "Which authentication method should you use?"
          echo "==========================================="
          echo ""
          echo "Need to access just ONE private repository?"
          echo "  └─→ Use Deploy Keys (SSH)"
          echo ""
          echo "Need to access MULTIPLE repositories in an Organization?"
          echo "  └─→ Use GitHub App"
          echo ""
          echo "Personal project with a few repositories?"
          echo "  └─→ Use Fine-grained PAT"
          echo ""
          echo "Just testing/prototyping?"
          echo "  └─→ Use Classic PAT (but don't commit it!)"
          echo ""
          echo "Accessing the SAME repository?"
          echo "  └─→ Use default GITHUB_TOKEN"

  # Example: Real-world usage pattern
  real-world-example:
    runs-on: ubuntu-latest

    steps:
      - name: Real-world scenario
        run: |
          cat << 'EOF'
          Real-World Scenario: Microservices Deployment
          ═══════════════════════════════════════════════

          Setup:
          ------
          Organization: my-company
          Repositories:
            - service-api (this repo)
            - service-auth
            - service-database
            - shared-config
            - deployment-scripts

          Requirement:
          -----------
          Deploy all services together, using shared configuration

          Solution: GitHub App
          -------------------

          1. Create GitHub App "Deployment Orchestrator"
          2. Grant permissions:
             - Contents: Read (for all repos)
             - Deployments: Write (for deployment tracking)
          3. Install on all 5 repositories
          4. Use in deployment workflow:

          ```yaml
          - uses: actions/create-github-app-token@v1
            id: app
            with:
              app-id: ${{ secrets.DEPLOY_APP_ID }}
              private-key: ${{ secrets.DEPLOY_APP_KEY }}
              repositories: |
                service-auth
                service-database
                shared-config
                deployment-scripts

          - uses: actions/checkout@v4
            with:
              repository: my-company/shared-config
              token: ${{ steps.app.outputs.token }}
              path: config

          - uses: actions/checkout@v4
            with:
              repository: my-company/deployment-scripts
              token: ${{ steps.app.outputs.token }}
              path: deploy

          - name: Deploy all services
            run: ./deploy/deploy-all.sh
          ```

          Benefits:
          --------
          ✓ Single authentication method for all repositories
          ✓ Easy to add/remove repository access
          ✓ Not dependent on any team member's personal token
          ✓ Automatic token rotation
          ✓ Clear audit trail of deployments
          EOF
